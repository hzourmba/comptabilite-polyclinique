# Guide de Comptabilit√© - Syst√®me Comptable Multi-Devises

## Table des Mati√®res

1. [Vue d'ensemble du syst√®me](#vue-densemble-du-syst√®me)
2. [Gestion des utilisateurs et s√©curit√©](#gestion-des-utilisateurs-et-s√©curit√©)
3. [Configuration des entreprises et devises](#configuration-des-entreprises-et-devises)
4. [Plan comptable et num√©rotation](#plan-comptable-et-num√©rotation)
5. [Gestion du capital et des actionnaires](#gestion-du-capital-et-des-actionnaires)
6. [√âcritures comptables](#√©critures-comptables)
7. [√âtats financiers](#√©tats-financiers)
8. [Troubleshooting et bonnes pratiques](#troubleshooting-et-bonnes-pratiques)

---

## Vue d'ensemble du syst√®me

### Caract√©ristiques principales

- **Multi-devises** : Support Euro (‚Ç¨) et Franc CFA (FCFA)
- **Multi-normes** : Comptabilit√© fran√ßaise et OHADA/Cameroun
- **Gestion des actionnaires** : Suivi d√©taill√© des souscriptions et lib√©rations
- **√âtats financiers automatis√©s** : Balance, Grand Livre, Bilan, Compte de R√©sultat

### Architecture des donn√©es

```
Entreprise
‚îú‚îÄ‚îÄ Utilisateurs (avec r√¥les et permissions)
‚îú‚îÄ‚îÄ Exercices comptables
‚îú‚îÄ‚îÄ Plan comptable (Comptes)
‚îÇ   ‚îú‚îÄ‚îÄ Comptes principaux
‚îÇ   ‚îî‚îÄ‚îÄ Sous-comptes (actionnaires, etc.)
‚îú‚îÄ‚îÄ Journaux
‚îî‚îÄ‚îÄ √âcritures comptables
    ‚îî‚îÄ‚îÄ Lignes d'√©criture
```

### Nouveaut√©s de la version actuelle

- **‚úÖ Gestion compl√®te des utilisateurs** : Cr√©ation, modification, activation/d√©sactivation
- **‚úÖ Syst√®me de r√¥les et permissions** : Administrateur, Comptable, Assistant Comptable, Consultant
- **‚úÖ S√©curit√© renforc√©e** : Authentification hybride, contr√¥le d'acc√®s bas√© sur les r√¥les
- **‚úÖ Initialisation automatique d'entreprise** : Cr√©ation automatique de l'exercice, plan comptable et utilisateur administrateur
- **‚úÖ Interface intuitive** : Gestion des permissions dynamiques dans l'interface
- **‚úÖ Profil utilisateur** : Possibilit√© de modifier ses informations personnelles et mot de passe

---

## Gestion des utilisateurs et s√©curit√©

### Syst√®me de r√¥les

Le syst√®me impl√©mente un contr√¥le d'acc√®s bas√© sur les r√¥les (RBAC) avec quatre niveaux de permissions :

#### 1. **ADMINISTRATEUR**
- **Permissions compl√®tes** : Acc√®s √† toutes les fonctionnalit√©s
- **Gestion des utilisateurs** : Cr√©ation, modification, activation/d√©sactivation
- **Administration du syst√®me** : Configuration entreprise, param√®tres globaux

#### 2. **COMPTABLE**
- **√âcritures comptables** : Cr√©ation, modification, validation
- **√âtats financiers** : G√©n√©ration de tous les rapports
- **Plan comptable** : Gestion des comptes
- **Consultation utilisateurs** : Lecture seule

#### 3. **ASSISTANT_COMPTABLE**
- **Saisie d'√©critures** : Cr√©ation et modification d'√©critures
- **Consultation** : Acc√®s en lecture aux √©tats financiers
- **Pas d'acc√®s** : Administration syst√®me

#### 4. **CONSULTANT**
- **Lecture seule** : Consultation des √©tats financiers uniquement
- **Pas de modification** : Aucune √©criture ou changement

### Interface de gestion des utilisateurs

#### Acc√®s √† l'interface
```
Menu ‚Üí Administration ‚Üí Gestion des utilisateurs
(Accessible uniquement aux administrateurs)
```

#### Fonctionnalit√©s disponibles

**üìã Liste des utilisateurs :**
- Statut (‚úÖ Actif / ‚ùå Inactif)
- Nom d'utilisateur
- Nom complet (Pr√©nom + Nom)
- Adresse email
- R√¥le (traduit en fran√ßais)
- Derni√®re connexion

**üîß Actions disponibles :**
- **‚ûï Ajouter** : Cr√©er un nouvel utilisateur
- **‚úèÔ∏è Modifier** : √âditer les informations (double-clic possible)
- **üîÑ Activer/D√©sactiver** : Changer le statut d'un utilisateur
- **üîÑ Actualiser** : Recharger la liste

### Cr√©ation d'un nouvel utilisateur

#### Informations requises
```
Nom d'utilisateur : [Unique dans l'entreprise]
Pr√©nom          : [Obligatoire]
Nom             : [Obligatoire]
Email           : [Unique, format valide]
R√¥le            : [S√©lection parmi les 4 r√¥les]
Mot de passe    : [Minimum 6 caract√®res]
Confirmation    : [Doit correspondre]
Statut          : [Actif par d√©faut]
```

#### Validation automatique
- ‚úÖ **Unicit√©** : Nom d'utilisateur et email uniques
- ‚úÖ **Format email** : Validation du format
- ‚úÖ **Mot de passe** : Longueur minimale et confirmation
- ‚úÖ **Champs obligatoires** : Tous les champs requis

### S√©curit√© des mots de passe

#### Syst√®me hybride
Le syst√®me supporte deux formats de mots de passe pour la compatibilit√© :

**Nouveaux utilisateurs (recommand√©) :**
```java
// Hashage automatique lors de la cr√©ation
String hashedPassword = Integer.toString(password.hashCode());
```

**Anciens utilisateurs (legacy) :**
```java
// Authentification compatible avec mots de passe en clair
boolean isValid = passwordInDb.equals(plainPassword) ||
                  passwordInDb.equals(hashedPassword);
```

#### Mise √† jour des mots de passe
- **Changement via profil** : Nouveau mot de passe automatiquement hash√©
- **Migration progressive** : Les anciens mots de passe sont hash√©s lors du changement

### Contr√¥le d'acc√®s interface

#### Protection menu Administration
```java
// Configuration dynamique des permissions
private void configureMenuPermissions() {
    boolean isAdministrateur = authService.isAdministrateur();
    userManagementMenuItem.setDisable(!isAdministrateur);
}
```

#### V√©rification backend
```java
// Protection double au niveau contr√¥leur
@FXML
private void showUtilisateurs(ActionEvent event) {
    if (!authenticationService.isAdministrateur()) {
        showError("Acc√®s refus√©", "Seuls les administrateurs...");
        return;
    }
    // ... Continuer uniquement si autoris√©
}
```

### Profil utilisateur

#### Acc√®s au profil
```
Menu ‚Üí Administration ‚Üí Mon profil
(Accessible √† tous les utilisateurs connect√©s)
```

#### Fonctionnalit√©s du profil
- **üë§ Informations personnelles** : Pr√©nom, nom, email
- **üîê Changement de mot de passe** : Avec v√©rification de l'ancien mot de passe
- **üè¢ Informations entreprise** : Affichage en lecture seule
- **üìÖ Derni√®re connexion** : Information de s√©curit√©

#### Validation changement mot de passe
```java
// V√©rification mot de passe actuel (hybride)
boolean passwordMatches = false;
if (passwordInDb.equals(currentPassword)) {
    passwordMatches = true; // Mot de passe en clair
} else if (passwordInDb.equals(hashedCurrentPassword)) {
    passwordMatches = true; // Mot de passe hash√©
}
```

---

## Configuration des entreprises et devises

### D√©tection automatique de la devise

Le syst√®me d√©tecte automatiquement la devise et les normes comptables :

#### Entreprises OHADA (FCFA)
- **Pays** : Cameroun, S√©n√©gal, C√¥te d'Ivoire, etc.
- **Devise** : Franc CFA (FCFA)
- **Format num√©rotation** : CMxxxxxxx
- **S√©parateur d√©cimal** : Espace (ex: 1 000 000)

#### Entreprises Europ√©ennes (Euro)
- **Pays** : France, Allemagne, Belgique, etc.
- **Devise** : Euro (‚Ç¨)
- **Format num√©rotation** : xxxxxxx
- **S√©parateur d√©cimal** : Virgule (ex: 1 000 000,00)

### Configuration dans l'application

```java
// La d√©tection se fait automatiquement via CurrencyService
boolean isOHADA = currencyService.isOHADAEntreprise();
String format = currencyService.getAmountInputFormat();
```

### Cr√©ation d'une nouvelle entreprise

#### Interface de cr√©ation
```
Menu ‚Üí Fichier ‚Üí Nouvelle entreprise
```

#### D√©tection intelligente de la devise
Le syst√®me d√©tecte automatiquement la devise et le plan comptable en fonction du contexte utilisateur :

**Utilisateur admin_france :**
- Pays : France (par d√©faut)
- Devise : Euro (‚Ç¨)
- Plan comptable : Fran√ßais (sans pr√©fixe CM)

**Autres utilisateurs :**
- Pays : Cameroun (par d√©faut)
- Devise : Franc CFA (FCFA)
- Plan comptable : OHADA (avec pr√©fixe CM)

#### Initialisation automatique
Lors de la cr√©ation d'une entreprise, le syst√®me initialise automatiquement :

1. **üìÖ Exercice comptable** : Exercice courant (du 1er janvier au 31 d√©cembre)
2. **üë§ Utilisateur administrateur** : Compte admin par d√©faut avec email g√©n√©r√©
3. **üìä Plan comptable de base** : Comptes essentiels selon les normes (fran√ßaise ou OHADA)

#### Comptes cr√©√©s automatiquement

**Plan comptable fran√ßais :**
```
101000 - Capital social
106000 - R√©serves
120000 - R√©sultat de l'exercice
411000 - Clients
401000 - Fournisseurs
512000 - Banque
530000 - Caisse
```

**Plan comptable OHADA :**
```
CM101000 - Capital social
CM106000 - R√©serves
CM120000 - R√©sultat de l'exercice
CM411000 - Clients
CM401000 - Fournisseurs
CM521000 - Banque
CM571000 - Caisse
```

#### Service d'initialisation
```java
@Service
public class EntrepriseInitializationService {

    public boolean initializeEntreprise(Entreprise entreprise) {
        // Initialisation en transaction unique
        Transaction transaction = session.beginTransaction();

        // 1. Cr√©er l'exercice par d√©faut
        Exercice exercice = createDefaultExercice(entreprise);

        // 2. Cr√©er l'utilisateur administrateur
        Utilisateur adminUser = createDefaultAdminUser(entreprise);

        // 3. Cr√©er le plan comptable de base
        boolean comptesCreated = createComptesDeBase(entreprise);

        transaction.commit();
        return true;
    }
}
```

---

## Plan comptable et num√©rotation

### Num√©rotation automatique

#### Format OHADA (Cameroun)
```
CM + Classe + Num√©ro s√©quentiel
Exemples :
- CM101000 : Capital social
- CM101001 : Actionnaire Oumarou Gaston
- CM521000 : Banque principale
```

#### Format Fran√ßais
```
Classe + Num√©ro s√©quentiel
Exemples :
- 101000 : Capital social
- 101001 : Actionnaire 1
- 512000 : Banque
```

### Classes comptables

| Classe | Description | Type | Exemples |
|--------|-------------|------|----------|
| 1 | Comptes de capitaux | Passif | Capital, R√©serves |
| 2 | Immobilisations | Actif | Mat√©riel, Brevets |
| 3 | Stocks | Actif | Marchandises |
| 4 | Comptes de tiers | Actif/Passif | Clients, Fournisseurs |
| 5 | Comptes financiers | Actif | Banque, Caisse |
| 6 | Charges | R√©sultat | Achats, Salaires |
| 7 | Produits | R√©sultat | Ventes, Prestations |

### Cr√©ation automatique des sous-comptes

```java
// Le syst√®me g√©n√®re automatiquement les num√©ros
String nextNumber = compteDAO.getNextNumeroInHierarchy(parentPrefix, entrepriseId);
```

---

## Gestion du capital et des actionnaires

### Strat√©gie recommand√©e : √âcritures comptables

**Nouvelle approche (recommand√©e) :**
1. Cr√©er les sous-comptes actionnaires √† solde z√©ro
2. Enregistrer chaque lib√©ration par √©criture comptable

**Avantages :**
- ‚úÖ Tra√ßabilit√© compl√®te des mouvements
- ‚úÖ Historique des lib√©rations
- ‚úÖ Facilite les audits
- ‚úÖ Respect des normes comptables

### Structure des comptes capital

```
CM101000 - Capital Social (compte principal)
‚îú‚îÄ‚îÄ CM101001 - Oumarou Gaston
‚îú‚îÄ‚îÄ CM101002 - Dembe Jean Claude
‚îú‚îÄ‚îÄ CM101003 - Abba Moussa
‚îî‚îÄ‚îÄ CM101004 - Adam Teichert Moussa
```

### √âcritures type pour lib√©ration

```
Date: [Date de virement]
Libell√©: Lib√©ration capital - [Nom actionnaire]

D√©bit  : CM521000 (Banque)          [Montant vers√©]
Cr√©dit : CM101001 (Actionnaire)     [Montant vers√©]
```

### Gestion des cas particuliers

#### Actionnaire d√©ficitaire (doit encore payer)
```
Solde du sous-compte : D√©biteur (+)
‚Üí Appara√Æt en CR√âANCES au bilan (Actif)
```

#### Actionnaire exc√©dentaire (a trop pay√©)
```
Solde du sous-compte : Cr√©diteur (-)
‚Üí Appara√Æt en DETTES au bilan (Passif)
```

---

## √âcritures comptables

### Principes de base

#### √âquilibre obligatoire
```
Œ£ D√©bits = Œ£ Cr√©dits
```

#### Num√©rotation automatique
- Format : `[ANN√âE]-[JOURNAL]-[NUM√âRO]`
- Exemple : `2024-VT-001`

### Types d'√©critures courantes

#### 1. Lib√©ration de capital
```
D√©bit  : 512000 (Banque)
Cr√©dit : 101001 (Actionnaire)
```

#### 2. Achat d'immobilisation
```
D√©bit  : 215000 (Mat√©riel m√©dical)
D√©bit  : 445660 (TVA d√©ductible)
Cr√©dit : 404000 (Fournisseur)
```

#### 3. Vente de prestation
```
D√©bit  : 411000 (Client)
Cr√©dit : 706000 (Prestations)
Cr√©dit : 445711 (TVA collect√©e)
```

### Validation des √©critures

Le syst√®me v√©rifie automatiquement :
- ‚úÖ √âquilibre d√©bit/cr√©dit
- ‚úÖ Comptes existants
- ‚úÖ Montants > 0
- ‚úÖ Date dans l'exercice

---

## √âtats financiers

### 1. Balance

**Colonnes affich√©es :**
- Num√©ro de compte
- Libell√©
- Total D√©bit
- Total Cr√©dit
- Solde D√©biteur
- Solde Cr√©diteur

**Utilisation :** V√©rification de l'√©quilibre comptable

### 2. Grand Livre

**Informations par compte :**
- Historique de tous les mouvements
- Solde cumule progressive
- Filtrage par p√©riode

**Utilisation :** Analyse d√©taill√©e d'un compte

### 3. Bilan

#### Structure Actif/Passif

**ACTIF :**
- Immobilisations (Classe 2)
- Actif circulant (Classe 3)
- Cr√©ances (Actions non lib√©r√©es)
- Tr√©sorerie (Banque, Caisse)

**PASSIF :**
- Capitaux propres (Capital + R√©sultat)
- Dettes (Fournisseurs + Sur-lib√©rations actionnaires)

#### Logique de consolidation

```java
// Comptes avec sous-comptes : utilise la consolidation
BigDecimal soldeConsolide = compte.getSoldeDebiteurConsolide();

// √âvite le double comptage parent/enfant
boolean hasSubAccounts = compte.getSousComptes() != null && !compte.getSousComptes().isEmpty();
```

#### Traitement sp√©cifique du capital

1. **Capital principal (CM101000)** ‚Üí Passif (576 000 000)
2. **Sous-comptes actionnaires :**
   - Solde d√©biteur ‚Üí Cr√©ances (actions non lib√©r√©es)
   - Solde cr√©diteur ‚Üí Dettes (sur-lib√©rations)

### 4. Compte de R√©sultat

**Structure :**
- Chiffre d'affaires (Classe 7)
- Charges d'exploitation (Classe 6)
- R√©sultat net = Produits - Charges

**Note :** Vide en phase de constitution (normal)

---

## Troubleshooting et bonnes pratiques

### Probl√®mes courants et solutions

#### 1. Bilan d√©s√©quilibr√©
**Cause :** Double comptage parent/enfant
**Solution :**
```java
// Exclure les comptes parents qui ont des sous-comptes
boolean hasSubAccounts = compte.getSousComptes() != null && !compte.getSousComptes().isEmpty();
if (!hasSubAccounts) {
    // Traiter seulement les comptes finaux
}
```

#### 2. Compte de r√©sultat qui ne s'ex√©cute pas
**Cause :** Probl√®me d'extraction de classe pour comptes OHADA
**Solution :**
```java
// Gestion des deux formats
if (numeroCompte.startsWith("CM") && numeroCompte.length() > 2) {
    return Integer.parseInt(numeroCompte.substring(2, 3)); // CM6xxxx ‚Üí 6
} else {
    return Integer.parseInt(numeroCompte.substring(0, 1)); // 6xxxx ‚Üí 6
}
```

#### 3. Cr√©ances mal calcul√©es
**Cause :** Confusion entre logique globale et d√©taill√©e
**Solution :** Traiter chaque actionnaire individuellement
```java
if (soldeNet.compareTo(BigDecimal.ZERO) > 0) {
    creances = creances.add(soldeNet); // Doit encore payer
} else if (soldeNet.compareTo(BigDecimal.ZERO) < 0) {
    dettes = dettes.add(soldeNet.abs()); // A trop pay√©
}
```

### Bonnes pratiques

#### 1. Saisie des √©critures
- ‚úÖ Toujours √©quilibrer d√©bit = cr√©dit
- ‚úÖ Utiliser des libell√©s explicites
- ‚úÖ V√©rifier les comptes utilis√©s
- ‚úÖ Respecter la chronologie

#### 2. Gestion des actionnaires
- ‚úÖ Cr√©er un sous-compte par actionnaire
- ‚úÖ Enregistrer chaque virement par √©criture
- ‚úÖ √âviter les soldes "magiques" sans justification
- ‚úÖ Documenter les sur-lib√©rations

#### 3. Cl√¥ture d'exercice
- ‚úÖ V√©rifier l'√©quilibre de la balance
- ‚úÖ Contr√¥ler la coh√©rence bilan/balance
- ‚úÖ Justifier tous les √©carts
- ‚úÖ Sauvegarder les √©tats avant cl√¥ture

#### 4. Maintenance du syst√®me
- ‚úÖ Sauvegardes r√©guli√®res de la base
- ‚úÖ Contr√¥les d'int√©grit√© p√©riodiques
- ‚úÖ Formation des utilisateurs
- ‚úÖ Documentation des proc√©dures sp√©cifiques

---

## √âvolution du syst√®me

### Phases d'utilisation

1. **Constitution** ‚Üí Capital, actionnaires, tr√©sorerie
2. **Investissement** ‚Üí Achats mat√©riel, am√©nagements (charges)
3. **Exploitation** ‚Üí Facturation clients (produits)
4. **Maturit√©** ‚Üí Gestion compl√®te actif/passif/r√©sultat

### Fonctionnalit√©s avanc√©es

- [ ] Gestion de la TVA
- [ ] Immobilisations et amortissements
- [ ] Paie et charges sociales
- [ ] Analyse financi√®re
- [ ] Budgets et pr√©visions
- [ ] Consolidation multi-soci√©t√©s

---

## Support et contact

Pour toute question ou am√©lioration du syst√®me :
1. Consulter les logs de l'application
2. V√©rifier ce guide de r√©f√©rence
3. Tester sur donn√©es d'exemple
4. Documenter les cas particuliers

---

*Guide cr√©√© le : {{ date }}*
*Version : 1.0*
*Derni√®re mise √† jour : {{ date }}*